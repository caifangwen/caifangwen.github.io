{{- $cfg := .Site.Params.blogHeatmap | default .Site.Params.githubHeatmap | default dict -}}
{{- $enabled := $cfg.enabled | default true -}}
{{- if not $enabled -}}
  {{- /* disabled */ -}}
{{- else -}}
  {{- $year := $cfg.year | default (int (now.Format "2006")) -}}
  {{- $yearStr := printf "%d" $year -}}
  {{- $title := $cfg.title | default "博客发布热力图" -}}
  {{- $viewAllURL := $cfg.viewAllUrl | default ("/posts/" | relLangURL) -}}

  {{- /* count posts per day */ -}}
  {{- $counts := newScratch -}}
  {{- $posts := where site.RegularPages "Section" "posts" -}}
  {{- range $posts -}}
    {{- if eq (dateFormat "2006" .Date) $yearStr -}}
      {{- $k := dateFormat "2006-01-02" .Date -}}
      {{- $cur := $counts.Get $k | default 0 -}}
      {{- $counts.Set $k (add $cur 1) -}}
    {{- end -}}
  {{- end -}}

  {{- /* compute days in year */ -}}
  {{- $isLeap := and (eq (mod $year 4) 0) (or (ne (mod $year 100) 0) (eq (mod $year 400) 0)) -}}
  {{- $daysInYear := cond $isLeap 366 365 -}}

  {{- /* compute max + total for scaling */ -}}
  {{- $start := time (printf "%d-01-01" $year) -}}
  {{- $max := 0 -}}
  {{- $total := 0 -}}
  {{- range seq $daysInYear -}}
    {{- $d := $start.AddDate 0 0 (sub . 1) -}}
    {{- $k := dateFormat "2006-01-02" $d -}}
    {{- $c := $counts.Get $k | default 0 -}}
    {{- $total = add $total $c -}}
    {{- if gt $c $max -}}{{- $max = $c -}}{{- end -}}
  {{- end -}}

  {{- /* pad cells so Jan 1 lands on correct weekday row (Sun=0) */ -}}
  {{- $weekdayMap := dict "Sun" 0 "Mon" 1 "Tue" 2 "Wed" 3 "Thu" 4 "Fri" 5 "Sat" 6 -}}
  {{- $pad := (index $weekdayMap (dateFormat "Mon" $start)) | default 0 -}}

  {{- $cells := slice -}}
  {{- range seq $pad -}}
    {{- $cells = $cells | append (dict "empty" true) -}}
  {{- end -}}

  {{- range seq $daysInYear -}}
    {{- $d := $start.AddDate 0 0 (sub . 1) -}}
    {{- $date := dateFormat "2006-01-02" $d -}}
    {{- $count := $counts.Get $date | default 0 -}}

    {{- $level := 0 -}}
    {{- if and (gt $count 0) (gt $max 0) -}}
      {{- $level = div (add (mul $count 4) (sub $max 1)) $max -}}
      {{- if gt $level 4 -}}{{- $level = 4 -}}{{- end -}}
    {{- end -}}

    {{- $cells = $cells | append (dict "date" $date "count" $count "level" $level) -}}
  {{- end -}}

  {{- $rem := mod (len $cells) 7 -}}
  {{- if ne $rem 0 -}}
    {{- range seq (sub 7 $rem) -}}
      {{- $cells = $cells | append (dict "empty" true) -}}
    {{- end -}}
  {{- end -}}

  {{- $weeks := div (len $cells) 7 -}}

  {{- /* month labels */ -}}
  {{- $monthLabels := slice -}}
  {{- range seq 12 -}}
    {{- $m := . -}}
    {{- $mStart := time (printf "%d-%02d-01" $year $m) -}}
    {{- $dayIdx := div (sub $mStart.Unix $start.Unix) 86400 -}}
    {{- if and (ge $dayIdx 0) (lt $dayIdx $daysInYear) -}}
      {{- $weekIdx := div (add $pad $dayIdx) 7 -}}
      {{- $monthLabels = $monthLabels | append (dict "label" (printf "%d月" $m) "week" $weekIdx) -}}
    {{- end -}}
  {{- end -}}

  {{- /* collect posts per date for click */ -}}
  {{- $byDate := newScratch -}}
  {{- range $posts -}}
    {{- if eq (dateFormat "2006" .Date) $yearStr -}}
      {{- $k := dateFormat "2006-01-02" .Date -}}
      {{- $list := $byDate.Get $k | default (slice) -}}
      {{- $byDate.Set $k ($list | append (dict "title" .Title "url" .RelPermalink)) -}}
    {{- end -}}
  {{- end -}}

  {{- $daysWithPosts := slice -}}
  {{- range seq $daysInYear -}}
    {{- $d := $start.AddDate 0 0 (sub . 1) -}}
    {{- $date := dateFormat "2006-01-02" $d -}}
    {{- $plist := $byDate.Get $date | default (slice) -}}
    {{- if gt (len $plist) 0 -}}
      {{- $daysWithPosts = $daysWithPosts | append (dict "date" $date "posts" $plist) -}}
    {{- end -}}
  {{- end -}}

  <section class="gh-heatmap-card bg-card border-border rounded-xl border p-6 shadow-sm mb-6">
    <div class="flex items-start justify-between gap-4 mb-4">
      <div class="min-w-0">
        <h2 class="text-foreground text-xl font-semibold leading-tight">
          {{ $title }}
        </h2>
        <div class="text-muted-foreground text-sm mt-1">
          {{ $year }}
        </div>
      </div>

      <a class="text-sm text-primary hover:text-primary/80 transition-colors whitespace-nowrap"
         href="{{ $viewAllURL }}">
        查看文章 →
      </a>
    </div>

    <div class="gh-heatmap-meta text-muted-foreground text-sm mb-3">
      <strong class="text-foreground font-semibold">{{ $total }}</strong> 篇发布（{{ $year }}）
    </div>

    <div class="gh-heatmap-scroll" role="region" aria-label="Blog publishing heatmap">
      <div class="gh-heatmap-months" aria-hidden="true">
        {{- range $monthLabels -}}
          <span class="gh-month" style="left: calc(var(--gh-step) * {{ .week }});">{{ .label }}</span>
        {{- end -}}
      </div>
      <div class="gh-heatmap-grid" style="--gh-weeks: {{ $weeks }};">
        {{- range $cells -}}
          {{- if .empty -}}
            <span class="gh-day gh-empty" aria-hidden="true"></span>
          {{- else -}}
            {{- $lvl := .level | default 0 -}}
            {{- $count := .count | default 0 -}}
            {{- $date := .date | default "" -}}
            <span
              class="gh-day gh-level-{{ $lvl }}"
              data-date="{{ $date }}"
              data-count="{{ $count }}"
              title="{{ $date }}：发布 {{ $count }} 篇"
              aria-label="{{ $date }}：发布 {{ $count }} 篇"></span>
          {{- end -}}
        {{- end -}}
      </div>
    </div>

    <div class="gh-heatmap-daypanel hidden" aria-live="polite">
      <div class="gh-heatmap-daypanel-header">
        <div class="gh-heatmap-daypanel-title">
          <span class="gh-heatmap-daypanel-date"></span>
          <span class="gh-heatmap-daypanel-count"></span>
        </div>
        <button type="button" class="gh-heatmap-daypanel-close" aria-label="关闭">×</button>
      </div>
      <ul class="gh-heatmap-daypanel-list"></ul>
    </div>

    <div class="gh-heatmap-legend text-muted-foreground text-xs mt-3 flex items-center justify-end gap-2">
      <span>少</span>
      <span class="gh-day gh-level-0" aria-hidden="true"></span>
      <span class="gh-day gh-level-1" aria-hidden="true"></span>
      <span class="gh-day gh-level-2" aria-hidden="true"></span>
      <span class="gh-day gh-level-3" aria-hidden="true"></span>
      <span class="gh-day gh-level-4" aria-hidden="true"></span>
      <span>多</span>
    </div>

    <script type="application/json" class="gh-heatmap-data">
      {{- $daysWithPosts | jsonify -}}
    </script>
    <script>
      (function () {
        const card = document.currentScript.closest(".gh-heatmap-card");
        if (!card) return;

        const grid = card.querySelector(".gh-heatmap-grid");
        const panel = card.querySelector(".gh-heatmap-daypanel");
        const closeBtn = card.querySelector(".gh-heatmap-daypanel-close");
        const dateEl = card.querySelector(".gh-heatmap-daypanel-date");
        const countEl = card.querySelector(".gh-heatmap-daypanel-count");
        const listEl = card.querySelector(".gh-heatmap-daypanel-list");
        const dataEl = card.querySelector("script.gh-heatmap-data");

        if (!grid || !panel || !closeBtn || !dateEl || !countEl || !listEl || !dataEl) return;

        let map = null;
        try {
          const arr = JSON.parse(dataEl.textContent || "[]");
          map = new Map(arr.map((x) => [x.date, x.posts || []]));
        } catch (e) {
          map = new Map();
        }

        function hidePanel() {
          panel.classList.add("hidden");
          grid.querySelectorAll(".gh-day.is-selected").forEach((el) => el.classList.remove("is-selected"));
        }

        function showFor(date, count) {
          dateEl.textContent = date;
          countEl.textContent = count > 0 ? `· 发布 ${count} 篇` : `· 当天未发布`;

          listEl.innerHTML = "";
          const posts = map.get(date) || [];
          if (posts.length) {
            for (const p of posts) {
              const li = document.createElement("li");
              const a = document.createElement("a");
              a.href = p.url;
              a.textContent = p.title;
              li.appendChild(a);
              listEl.appendChild(li);
            }
          }

          panel.classList.remove("hidden");
        }

        grid.addEventListener("click", (e) => {
          const cell = e.target && e.target.closest && e.target.closest(".gh-day[data-date]");
          if (!cell) return;

          const date = cell.getAttribute("data-date") || "";
          const count = Number(cell.getAttribute("data-count") || "0");
          if (!date) return;

          grid.querySelectorAll(".gh-day.is-selected").forEach((el) => el.classList.remove("is-selected"));
          cell.classList.add("is-selected");
          showFor(date, count);
        });

        closeBtn.addEventListener("click", hidePanel);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Escape") hidePanel();
        });
      })();
    </script>
  </section>
{{- end -}}
